// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "./base/BaseTest.t.sol";
import "forge-std/Test.sol";
import "../src/ExpirableERC721.sol";
import "./utils/Utilities.sol";
import "../script/ExpirableERC721.s.sol";

contract ExpirableERC721Test is BaseTest {
    Utilities internal utils;
    address internal alice;
    address internal bob;
    address internal carol;
    address payable[] internal users;

    ExpirableERC721 public erc721;
    ExpirableERC721 public sismoERC721;
    ExpirableERC721DeployScript public deployer;
    address public deployerAddress;

    //proof of human group ID
    bytes16 public constant groupID = 0xd630aa769278cacde879c5c0fe5d203c;
    //hard coded sismo proof
    bytes response =
        hex"0000000000000000000000000000000000000000000000000000000000000020f16f189921c7684c3d6f5b471d5e117800000000000000000000000000000000b8e2054f8a912367e38a22ce773328ff000000000000000000000000000000007369736d6f2d636f6e6e6563742d76312e31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000bbfa3762f4e91230cd96b72b9a7de80e824468a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000125b64eb793153a2017c4ad443dfde339587f489c43d7972fc0907f81461495d900000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c01c4b29996ed60dc591b4f8bc80a8e607127bdd5483a4e35f91cf72cd231b72cd095efc34fe9a0079ecba43532d32ef015e153920254cb5b3f45550d9423e7f3e111ca95045ea3d653499402ecc01c4f09f7775d4e7855b91c39b6b7bf5bc46590d13eb1e9362043d904644242955928adbb7c82a9c175fab891c83808037592e2a406b35fd2309c6acd2b2ca8af531cd1d97df2728eaee1a198eef679f6212a11dad3ed439844efe14d987bf7604f7aa017443a09d3a320e573e9e29913ea20625e6c065b53798f065bc29ba652585956573c37bdd1acc3599273d22397f222e21ee3b3b0ea7b0d62d630d9077132e9b4486ae6488981ace8f1a9b5b43b03f0300000000000000000000000000000000000000000000000000000000000000000d42adc26476af82972f4af6390601c100dfb6c786585a81fe4c2aa825eba7201801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000025b64eb793153a2017c4ad443dfde339587f489c43d7972fc0907f81461495d90e27ec98edd2816fced4c202f698df9cae81feb39f6f73358ac1aba36f2b8dc300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c068796472612d73332e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000d630aa769278cacde879c5c0fe5d203c000000000000000000000000000000006c617465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c00266ba223a1ff4d08c69fbebaf5338ed260170d0b2c75b2bfaca8677d7b15ba61b9e895103f4eecdc791888035effe98ce596e359457914825433de16898a64711840d129a5b67936ac20159d675b89e1f94d2ac207d18378e59e6acd9d1832b233d5b4063c5a07dcb203a73d793f613125fdfc36a615a0adb1b3bf63b2e9f981cf88c5271529a9227add3a15ba1de75ad0c9d9a6cb07aae79a77bae51513a9d2f95dd1ad90a12ca46d77ec41c90bd2c9ef797b248ec5a85cd83b6dc0183bccb0180271655931758322605d4d56e0535cdc0cb0598dd11b234978677ae9e777204fb4ff10801769a82a427d44a7df328449bb94c5b8b9eb5f44f631326d3afea00000000000000000000000000000000000000000000000000000000000000000d42adc26476af82972f4af6390601c100dfb6c786585a81fe4c2aa825eba7201801b584700a740f9576cc7e83745895452edc518a9ce60b430e1272fc4eb93b057cf80de4f8dd3e4c56f948f40c28c3acbeca71ef9f825597bf8cc059f1238b2bd3fc614ab0e57ca20c1fced2d8838684920777cc28aa8238bc40537368dbe820a1dc4d29d05151b32434bf44bc88aeb91753d3a799c04dd46d64e3a0120b4d1f2dcf00c37d2aa6d981edb3f93e3119fd4dd38b4a05e842e3fb6c1fc972e9250000000000000000000000000000000000000000000000000000000000000001149f70ab0db24a270738aee6f857bec7cb91d3438c8e3dbaf07829b03ffffffc000000000000000000000000000000000000000000000000000000000000000025b64eb793153a2017c4ad443dfde339587f489c43d7972fc0907f81461495d90e27ec98edd2816fced4c202f698df9cae81feb39f6f73358ac1aba36f2b8dc3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    function setUp() public {
        deployer = new ExpirableERC721DeployScript();
        erc721 = deployer.run2("A", "B", groupID, false);
        sismoERC721 = deployer.run2("C", "D", groupID, true);

        utils = new Utilities();
        users = utils.createUsers(3);
        alice = users[0];
        bob = users[1];
        carol = users[2];
    }

    function testMint() public {
        vm.prank(alice);
        erc721.mint(alice, "");

        assertEq(erc721.balanceOf(alice), 1);
    }

    function testSismoMint() public {
        vm.prank(address(0xBBFA3762f4E91230Cd96b72B9a7de80E824468A0));
        sismoERC721.mint(alice, response);

        assertEq(sismoERC721.balanceOf(alice), 1);
    }

    function testLendAndReclaim() public {
        vm.startPrank(alice);
        uint256 nftId = erc721.mint(alice, "");
        assertEq(alice, erc721.ownerOf(nftId));
        // lend to bob
        erc721.lend(bob, nftId, block.timestamp + 100);

        assertEq(bob, erc721.ownerOf(nftId));

        vm.warp(block.timestamp + 110);
        vm.stopPrank();

        vm.startPrank(carol);
        erc721.reclaim(nftId);

        assertEq(alice, erc721.ownerOf(nftId));

        vm.expectRevert();
        erc721.reclaim(nftId);
    }
}
